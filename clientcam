--// Roblox Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

--// Folders
local Services = ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Services")
local Remotes = ReplicatedStorage:WaitForChild("Remotes")

--// Remotes
local FireRemote = Remotes:WaitForChild("Fire")
local CameraRemote = Remotes:WaitForChild("Camera")
local RequestDataRemote = Remotes:WaitForChild("RequestData")

--// Custom Services
local CrosshairService = require(Services:WaitForChild("CrosshairServiceClient"))

local Player = Players.LocalPlayer

--// Booleans
local IsFirstPerson = false
local IsCrouching = false

--// Variables
local Camera = workspace.CurrentCamera

local CameraServiceClient = {}

--// Functions

function CameraServiceClient:ToggleFirstPerson()
	if IsFirstPerson then
		Player.CameraMode = Enum.CameraMode.Classic
		UserInputService.MouseIconEnabled = true
		CrosshairService:ToggleCrosshair()
		IsFirstPerson = false
	else
		Player.CameraMode = Enum.CameraMode.LockFirstPerson
		UserInputService.MouseIconEnabled = false
		CrosshairService:ToggleCrosshair()
		IsFirstPerson = true
		end
end

--// Crouch

local crouchOffset = 0
local targetCrouchOffset = 0
local IsCrouching = false
local LastRecoilTime = 0

function CameraServiceClient:Crouch()

	
	IsCrouching = not IsCrouching
	targetCrouchOffset = IsCrouching and -1 or 0
end

RunService:BindToRenderStep("CameraCrouch", Enum.RenderPriority.Camera.Value + 1, function(dt)
	crouchOffset = crouchOffset + (targetCrouchOffset - crouchOffset) * math.clamp(dt * 12, 0, 1)

	local camera = workspace.CurrentCamera
	camera.CFrame = camera.CFrame * CFrame.new(0, crouchOffset, 0)
end)

--[[function CameraServiceClient:ApplyRecoil()
	local Camera = workspace.CurrentCamera
	for i = 0, 0.4, 0.1 do
		local Goal = Camera.CFrame * CFrame.Angles(math.rad(1), math.rad(0), math.rad(0))
		local NewCF = Camera.CFrame:Lerp(Goal, i)
		Camera.CFrame = NewCF
		game:GetService("RunService").RenderStepped:Wait()
	end
	for i = 0.4, 0, -0.1 do
		local Goal = Camera.CFrame * CFrame.Angles(math.rad(-1), math.rad(0), math.rad(0))
		local NewCF = Camera.CFrame:Lerp(Goal, i)
		Camera.CFrame = NewCF
		game:GetService("RunService").RenderStepped:Wait()
	end
end--]]

--// Recoil

local recoilOffset = Vector3.new(0, 0, 0)
local recoilRecovery = 15


local function AddRecoil(pitch, yaw)

	recoilOffset = recoilOffset + Vector3.new(math.rad(pitch), math.rad(yaw), 0)

end

RunService.RenderStepped:Connect(function(dt)

	recoilOffset = recoilOffset:Lerp(Vector3.new(0, 0, 0), dt * recoilRecovery)

	local baseCFrame = Camera.CFrame
	Camera.CFrame = baseCFrame * CFrame.Angles(recoilOffset.X, recoilOffset.Y, recoilOffset.Z)
end)

--// Connections

function CameraServiceClient:Init()
	CameraServiceClient:ToggleFirstPerson()
end

FireRemote.OnClientEvent:Connect(function()
	AddRecoil(0.15, 0)
end)

CameraRemote.OnClientEvent:Connect(function(Action)
	if Action == "Crouch" then
		CameraServiceClient:Crouch()
	end
end)

CameraServiceClient:Init()

type CameraServiceClient = typeof(CameraServiceClient)

return CameraServiceClient :: CameraServiceClient
